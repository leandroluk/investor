---
title: Link User Wallet
---

import {MermaidZoom} from '#/components/molecules/MermaidZoom'
import {Web3SignatureDemo} from '#/components/molecules/Web3SignatureDemo'


## Rules

- **Uniqueness**: A wallet address can only be linked to **one** user account. Attempting to link an address already in use by another user will return `409 Conflict`.
- **Proof of Ownership**: The user must prove ownership of the wallet private key by signing a message.
- **Phishing Protection (EIP-4361)**: The message to be signed must follow the EIP-4361 standard, including the domain, address, statement, URI, version, chain ID, nonce, and issued-at timestamp.
- **Nonce Security**: 
  - A cryptographic nonce must be requested from the backend before signing.
  - The nonce is short-lived (TTL) and single-use (invalidated after verification attempt).

## Interactive Demo

The following interactive component demonstrates a web application integration with MetaMask to perform the cryptographic nonce signature.

<Web3SignatureDemo />

## Request

- **Method**: `POST`
- **Path**: `/account/wallet/link`
- **Headers**:
    - `Authorization`: `Bearer <token>`

### Body

```json
{
  "walletAddress": "0x123...",
  "signature": "0x999...",
  "message": "...", // The full EIP-4361 message string that was signed
  "nonce": "abc-123",
  "name": "My Main Wallet"
}
```

## Diagram

<MermaidZoom>
```mermaid
flowchart TD
    A["API received Link Request"] --> B{"Validate Body Schema"}
    B -- Invalid --> C["Return 400 Bad Request"]
    B -- Valid --> D{"Verify Nonce in Cache"}
    D -- "Not Found / Expired" --> E["Return 400 Bad Request"]
    D -- Valid --> F["Recover Address from Signature"]
    F --> G{"Recovered == Payload Address?"}
    G -- No --> H["Return 422 Unprocessable Entity"]
    G -- Yes --> I{"Address Already Linked?"}
    I -- Yes --> J["Return 409 Conflict"]
    I -- No --> K["Link Wallet to User"]
    K --> L["Invalidate Nonce"]
    L --> M["Return 201 Created"]
```
</MermaidZoom>

## Success Case

- **Status**: `201 Created`

```json
{
  "id": "wallet-uuid",
  "address": "0x71C765...d8976f",
  "name": "My Main Wallet",
  "network": "ethereum",
  "linkedAt": "2023-10-27T10:00:00Z"
}
```

## Error Case

- **Status**: `409 Conflict` (Wallet already in use)

```json
{
  "correlationId": "uuid-v7",
  "code": "wallet.already_exists",
  "message": "The wallet address 0x71C... is already linked to another account.",
  "occurredAt": "2023-01-01T00:00:00.000Z"
}
```
