name: "investor"

networks:
  investor:
    name: "investor"

services:
  investor-postgres:
    image: "postgres:15"
    hostname: "postgres"
    container_name: "investor-postgres"
    networks: [ "investor" ]
    ports: [ "${DOCKER_POSTGRES_PORT:?DOCKER_POSTGRES_PORT is required}:5432" ]
    environment:
      POSTGRES_USER: "${DOCKER_POSTGRES_USERNAME:?DOCKER_POSTGRES_USERNAME is required}"
      POSTGRES_PASSWORD: "${DOCKER_POSTGRES_PASSWORD:?DOCKER_POSTGRES_PASSWORD is required}"
      POSTGRES_DB: "${DOCKER_POSTGRES_DATABASE:?DOCKER_POSTGRES_DATABASE is required}"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  investor-liquibase:
    image: "liquibase/liquibase:4.33-alpine"
    hostname: "liquibase"
    container_name: "investor-liquibase"
    platform: "linux/amd64"
    networks: [ "investor" ]
    depends_on:
      investor-postgres:
        condition: "service_healthy"
    volumes: [ "./db/:/liquibase/changelog/" ]
    command: >
      bash -c "liquibase
      --url=jdbc:postgresql://investor-postgres:5432/${DOCKER_POSTGRES_DATABASE}
      --searchPath=/liquibase/changelog
      --changeLogFile=changelog.xml
      --username=${DOCKER_POSTGRES_USERNAME}
      --password=${DOCKER_POSTGRES_PASSWORD}
      --databaseChangeLogTableName=_changelog
      --databaseChangeLogLockTableName=_changelog_lock
      updateToTag ${DOCKER_LIQUIBASE_TAG}"
      
  investor-dragonfly:
    image: "dragonflydb/dragonfly:v1.27.1"
    hostname: "dragonfly"
    container_name: "investor-dragonfly"
    networks: [ "investor" ]
    ports: [ "${DOCKER_DRAGONFLY_PORT:?DOCKER_DRAGONFLY_PORT is required}:6379" ]
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD", "redis-cli", "-h", "localhost", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  investor-minio:
    image: "minio/minio:latest"
    hostname: "minio"
    container_name: "investor-minio"
    networks: [ "investor" ]
    ports:
      - "${DOCKER_MINIO_API_PORT:?DOCKER_MINIO_API_PORT is required}:9000"
      - "${DOCKER_MINIO_CONSOLE_PORT:?DOCKER_MINIO_CONSOLE_PORT is required}:9001"
    environment:
      MINIO_ROOT_USER: "${DOCKER_MINIO_ROOT_USER:?DOCKER_MINIO_ROOT_USER is required}"
      MINIO_ROOT_PASSWORD: "${DOCKER_MINIO_ROOT_PASSWORD:?DOCKER_MINIO_ROOT_PASSWORD is required}"
    command: "server /data --console-address :9001"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -o /dev/null http://localhost:9000/minio/health/live || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  investor-minio-create-bucket:
    image: "minio/mc:latest"
    hostname: "minio-create-bucket"
    container_name: "investor-minio-create-bucket"
    networks: [ "investor" ]
    depends_on:
      investor-minio:
        condition: "service_healthy"
    entrypoint: >
      /bin/sh -c " until /usr/bin/mc alias set minio http://investor-minio:9000 ${DOCKER_MINIO_ROOT_USER} ${DOCKER_MINIO_ROOT_PASSWORD}; do
        sleep 2;
      done; /usr/bin/mc mb minio/${DOCKER_MINIO_BUCKET:?DOCKER_MINIO_BUCKET is required} || true; /usr/bin/mc anonymous set public minio/${DOCKER_MINIO_BUCKET} || true; exit 0; "

  investor-kafka:
    image: "bitnamilegacy/kafka:4.0.0-debian-12-r10"
    hostname: "kafka"
    container_name: "investor-kafka"
    networks: [ "investor" ]
    ports: [ "${DOCKER_KAFKA_PORT:?DOCKER_KAFKA_PORT is required}:29092" ]
    environment:
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@investor-kafka:9093"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,PLAINTEXT_HOST://:29092"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://investor-kafka:9092,PLAINTEXT_HOST://localhost:${DOCKER_KAFKA_PORT}"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CFG_LOG_MESSAGE_TIMESTAMP_TYPE: "CreateTime"
    healthcheck:
      test: [ "CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  investor-kafka-ui:
    image: "provectuslabs/kafka-ui:latest"
    hostname: "kafka-ui"
    container_name: "investor-kafka-ui"
    networks: [ "investor" ]
    depends_on:
      investor-kafka:
        condition: "service_healthy"
    ports: [ "${DOCKER_KAFKA_UI_PORT:?DOCKER_KAFKA_UI_PORT is required}:8080" ]
    environment:
      KAFKA_CLUSTERS_0_NAME: "investor"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "investor-kafka:9092"
      DYNAMIC_CONFIG_ENABLED: "true"
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  
  investor-grafana-loki:
    image: "grafana/loki:2.9.4"
    hostname: "loki"
    container_name: "investor-grafana-loki"
    networks: [ "investor" ]
    ports: [ "${DOCKER_GRAFANA_LOKI_PORT:?DOCKER_GRAFANA_LOKI_PORT is required}:3100" ]
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  investor-grafana:
    image: "grafana/grafana:latest"
    hostname: "grafana"
    container_name: "investor-grafana"
    networks: [ "investor" ]
    volumes: [ "./deploy/grafana/provisioning:/etc/grafana/provisioning" ]
    depends_on:
      investor-grafana-loki:
        condition: "service_healthy"
    ports: [ "${DOCKER_GRAFANA_PORT:?DOCKER_GRAFANA_PORT is required}:3000" ]
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: true
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  investor-sonarqube-create-db:
    image: "postgres:15"
    container_name: "investor-sonarqube-create-db"
    networks: [ "investor" ]
    depends_on:
      investor-postgres:
        condition: "service_healthy"
    command: >
      sh -c "
      export PGPASSWORD=${DOCKER_POSTGRES_PASSWORD};
      until pg_isready -h investor-postgres -U ${DOCKER_POSTGRES_USERNAME}; do sleep 2; done;
      psql -h investor-postgres -U ${DOCKER_POSTGRES_USERNAME} -d ${DOCKER_POSTGRES_DATABASE} -tc \"SELECT 1 FROM pg_database WHERE datname = 'sonarqube'\" | grep -q 1 ||
      createdb -h investor-postgres -U ${DOCKER_POSTGRES_USERNAME} sonarqube; exit 0"

  investor-sonarqube:
    image: "sonarqube:community"
    hostname: "sonarqube"
    container_name: "investor-sonarqube"
    networks: [ "investor" ]
    depends_on:
      investor-sonarqube-create-db:
        condition: "service_completed_successfully"
      investor-postgres:
        condition: "service_healthy"
    ports: [ "${DOCKER_SONARQUBE_PORT:?DOCKER_SONARQUBE_PORT is required}:9000" ]
    environment:
      SONAR_JDBC_URL: "jdbc:postgresql://investor-postgres:5432/sonarqube"
      SONAR_JDBC_USERNAME: "${DOCKER_POSTGRES_USERNAME}"
      SONAR_JDBC_PASSWORD: "${DOCKER_POSTGRES_PASSWORD}"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/system/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s      